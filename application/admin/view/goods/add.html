<!doctype html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {include file="admin@/public/global_css" /}
	<!--多图上传插件css-->
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/file/css/fileinput.css" media="all" />
	<link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/css/plugins/chosen/chosen.css" >
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
	<div class="row">
	<div class="col-sm-12">
		<div class="ibox float-e-margins">
			<div class="ibox-content">
				<form class="form-horizontal"  action="{:url('add')}">
					<ul class="nav nav-tabs" role="tablist">
						<li role="presentation" class="active">
							<a href="#home" aria-controls="home" role="tab" data-toggle="tab">基础信息</a>
						</li>
						<!--<li role="presentation" class="tab tab1" >
							<a href="#two" aria-controls="two" role="tab" data-toggle="tab">商品相册</a>
						</li>-->
						<li role="presentation" class="tab tab2" >
							<a href="#three" aria-controls="three" role="tab" data-toggle="tab">商品模型</a>
						</li>
						<li role="presentation" class="tab tab2" >
							<a href="#four" aria-controls="four" role="tab" data-toggle="tab">其余杂项</a>
						</li>
					</ul>
					<div class="tab-content">
						<!--基础信息-->
						<div role="tabpanel" class="tab-pane active" id="home">
							<div class="panel-body">
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>商品名称</span>
									</label>
									<div class="col-sm-8">
										<input type="text" name="goods_name" class="form-control">
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>商品分类</span>
									</label>
									<div class="col-sm-8">
										<select name="cat_id" class="form-control">
											<option value="0">请选择</option>
											{volist name="cates" id="vo"}
												<option value="{$vo.id|default=''}">{$vo.htmlname}</option>
											{/volist}
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>商品所属导航栏</span>
									</label>
									<div class="col-sm-8">
										<select name="nav_id" class="form-control">
											<option value="0">请选择</option>
											{volist name="goods_nav" id="vo"}
												<option value="{$vo.id|default=''}">{$vo.name}</option>
											{/volist}
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>商品货号</span>
									</label>
									<div class="col-sm-8">
										<input type="text" name="goods_sn" class="form-control" placeholder="自动生成" readonly="true">
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>商品品牌</span>
									</label>
									<div class="col-sm-8">
										<select name="brand_id" class="form-control">
											<option value="0">请选择</option>
											{volist name="brand" id="vo"}
											<option value="{$vo.id|default=''}">{$vo.name}</option>
											{/volist}
										</select>
									</div>
								</div>
								<div class="form-group" >
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>设计师选择</span>
									</label>
									<div class="col-sm-8">
										<select name="user_id" class="form-control">
											<option value="0">请选择</option>
											{volist name="designer" id="vo"}
											<option value="{$vo.user_id|default=''}">{$vo.nickname}</option>
											{/volist}
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>售价</span>
									</label>
									<div class="col-sm-8">
										<input type="text" name="price" class="form-control">
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>视频上传</span>
									</label>
									<div class="col-sm-8">
										<a class="btn btn-primary btn-video" dt-name="video" dt-value="" dt-group="goods_video" dt-size="200">视频上传</a>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>视频封面图</span>
									</label>
									<div class="col-sm-8">
										<a class="btn btn-primary btn-img" dt-name="video_img" dt-value=""  dt-group="goods_video_img" dt-max="1">图片上传</a>
									</div>	
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>尺码表图</span>
									</label>
									<div class="col-sm-8">
										<a class="btn btn-primary btn-img" dt-name="size_img" dt-value=""  dt-group="goods_size_img" dt-max="1">图片上传</a>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>商品图片</span>
									</label>
									<div class="col-sm-8">
										<a class="btn btn-primary btn-img" dt-name="original_img" dt-value=""  dt-group="goods" dt-max="1">图片上传</a>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>关键词</span>
									</label>
									<div class="col-sm-8">
										<input type="text" name="keywords" class="form-control" placeholder='多个关键词用"-"隔开'>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>商品简介</span>
									</label>
									<div class="col-sm-8">
										<textarea class="form-control" name="goods_remark"></textarea>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>时装说</span>
									</label>
									<div class="col-sm-8">
										<script id="content"  name="goods_content" class="ue-editor"></script>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>排序</span>
									</label>
									<div class="col-sm-8">
										<input type="text" name="sort" class="form-control" placeholder="默认为0 越大越靠前">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label"><span>是否开启预售</span></label>
									<div class="col-sm-8">
										<div class="layui-form">
											<input type="checkbox" name="is_pre_sale" value="1" checked lay-skin="switch" lay-filter="switch" lay-text="开启|关闭">
										</div>
									</div>
								</div>
								<div id="pre_sale_div">
									<div class="modal-footer"></div>
									<div class="form-group">
										<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>预售开始时间</span></label>
										<div class="col-sm-8">
											<div class="layui-form">
												<input type="text" class="date-time form-control w120" name="pre_sale_start_time">
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>预售结束时间</span></label>
										<div class="col-sm-8">
											<div class="layui-form">
												<input type="text" class="date-time form-control w120" name="pre_sale_end_time">
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>预售件数</span></label>
										<div class="col-sm-8">
											<div class="layui-form">
												<input type="text" name="pre_sale_num" class="form-control" onkeyup="this.value=this.value.replace(/[^\d]/g,'')">
											</div>
										</div>
									</div>
									<div class="modal-footer"></div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>是否纯成衣</span></label>
									<div class="col-sm-8">
										<label style="padding-right:15px;">
											<input type="radio" name="is_complete" value="1"  >是
										</label>
										<label>
											<input type="radio"  name="is_complete" value="0" checked>否
										</label>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>是否上架</span></label>
									<div class="col-sm-8">
										<label style="padding-right:15px;">
											<input type="radio" name="is_on_sale" value="1" checked >是
										</label>
										<label>
											<input type="radio"  name="is_on_sale" value="0">否
										</label>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>是否推荐</span></label>
									<div class="col-sm-8">
										<label style="padding-right:15px;">
											<input type="radio" name="is_recommend" value="1" checked >是
										</label>
										<label>
											<input type="radio"  name="is_recommend" value="0">否
										</label>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-3 control-label"><span class="text-danger">*</span><span>是否热门</span></label>
									<div class="col-sm-8">
										<label style="padding-right:15px;">
											<input type="radio" name="is_hot" value="1" checked >是
										</label>
										<label>
											<input type="radio"  name="is_hot" value="0">否
										</label>
									</div>
								</div>
							</div>
						</div>
						<!--商品相册-->
						<!--<div role="tabpanel" class="tab-pane" id="two">
							<div class="panel-body">
								<div class="form-group" >
									<input id="file" type="file" multiple="multiple" name="images">
								</div>
							</div>
						</div>-->
						<!--end-->
						<!--商品模型-->
						<div role="tabpanel" class="tab-pane" id="three">
							<div class="panel-body">
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span class="text-danger">*</span>
										<span>请选择商品模型</span>
									</label>
									<div class="col-sm-8">
										<select name="model_id" class="form-control" id="goods_model">
											<option value="0">请选择</option>
											{volist name="goods_model" id="vo"}
												<option value="{$vo.id|default=''}">{$vo.name}</option>
											{/volist}
										</select>
									</div>
								</div>
								<div class="form-group" id="ajax_spec_data"></div>
								<div class="form-group" id="spec_item_tab"></div>
							</div>
						</div>
						<!--end-->
						<!--其余杂项-->
						<div role="tabpanel" class="tab-pane" id="four">
							<div class="panel-body">
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>风格搭配</span>
									</label>
									<div class="col-sm-8">
									<div class="chosen-container-multi" style="width: 500px;">
										<ul class="chosen-choices" style="background-color:#eee;">
										</ul>
									</div>
									</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">搜索</label>
										<div class="col-sm-8">
											<div  style="width: 500px;">
												<input type="text" class="form-control" id="search" placeholder="商品名查询">
											</div>
											<div style="display:none;" id="select_div">
												<select class="form-control" multiple style="width:500px;height:150px;">
												</select>
											</div>
										</div>
								</div>
								<div class="form-group">
									<label class="control-label col-sm-3">
										<span>工艺披露上传</span>
									</label>
									<div class="col-sm-8">
										<a class="btn btn-primary btn-files" dt-name="material" dt-value="" dt-group="goods_file" dt-max="3">披露材料上传</a>
									</div>
								</div>
							</div>
						</div>
						<!--end-->
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary btn-comply">确定</button>
						<button type="button" class="btn btn-default btn-close" >取消</button>
					</div>
				</form>
			</div>
		</div>
		</div>
	</div>
</div>
{include file="admin@/public/global_js"/}
{include file="admin@/public/public_js"/}
<!--多图上传插件js-->
<script type="text/javascript" src="__PUBLIC__/admin/file/js/fileinput.js" type="text/javascript"></script>
</body>
<script type="text/javascript">
layui.use(['form'], function(){
	var form = layui.form,layer = layui.layer;
	//监听指定开关
	form.on('switch(switch)', function(data){
		$(data.elem).attr('type', 'hidden').val(this.checked ? 1 : 0);
		$('#pre_sale_div').toggle();
	});
});
//初始化filleinput控件
$('#file').fileinput({
	language: 'zh', //设置语言
	uploadUrl: "{:url('admin/Uploads/uploadImg')}",    //上传的地址
	allowedFileExtensions:['jpg','png','gif','jpeg'],    //接收的文件后缀
	showUpload:true,    //是否显示上传按钮
	showCaption:false,    //是否显示标题
	maxFileSize: 0,    //图片最大尺寸kb 为0不限制
	maxFilesNum: 3,        //最多上传图片
	overwriteInitial: false,//不覆盖已上传的图片
	browseClass: "btn btn-primary", //按钮样式
	dropZoneEnabled: true,//是否显示拖拽区域
	previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
	msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
	uploadExtraData:function (previewId, index) {
		return {
			category : 'goods',
		};
	},
});
// 插件相册上传回调监听事件
$("#file").on("fileuploaded", function (event, data, previewId, index) {
	//对象
    var oop = eval('(' + data.response + ')');
	var group = oop.category;
	var name = oop.res;
	var html = '<input type="hidden" name="img_url[]" value='+group+'/'+name+'>';
	$(this).before(html);
});
//删除生成的input
$(document).on('click','.fileinput-remove',function(){
	$('input[name="img_url[]"]').remove();
});
// 商品模型change,ajax调用返回不同的属性输入框
$(document).on("change",'#goods_model',function(){
	//var goods_id = $("input[name='goods_id']").val();
	var model_id = $(this).val();
	get_goods_spec_select(model_id);
	$("#spec_item_tab").html('');
})
//批量填充
$(document).on("click", '#item_fill', function () {
	var item_price_fill = $("#item_price").val();
	var item_cost_price_fill = $("#item_cost_price").val();
	var item_store_count_fill = $("#item_store_count").val();
	$("input[name$='[price]']").val(item_price_fill);
	$("input[name$='[cost_price]']").val(item_cost_price_fill);
	$("input[name$='[store_count]']").val(item_store_count_fill);
})
//商品模型切换时，返回不同的规格输入框
function get_goods_spec_select(model_id){
	var url = "{:url('ajaxSpecSelect')}";
	$.post(url,{'model_id':model_id,'goods_id':0},function(res){
		$("#ajax_spec_data").html('').append(res);
		ajaxGetSpecInput();	// 触发完  马上触发 规格输入框
	});
};
//风格搭配选择
$('#search').focus(function(){
	$("#select_div").show();
})
$('#search').on('keyup',function(){
	var value = $(this).val();
	var url = "{:url('search_style')}";
	//遍历获取以选中的goods_id
	var goods_id = '';
	$(".chosen-choices input[name='style_match[]']").each(function() {
		goods_id += $(this).val() + ",";
	});
	goods_id = goods_id.substring(0, goods_id.length - 1);//去除最后一个逗号
	$.post(url,{'value':value,'goods_id':goods_id},function(res){
		if(res.status){
			$('#select_div').find('option').remove();
			var html = '';
			for(var i = 0; i < res.data.length; i++){
				html += '<option value='+res.data[i].goods_id+'>'+res.data[i].goods_name+'</option>'
			}
			$('#select_div').find('select').append(html);
			return false;
		}
		return layer.msg('error connection!',{icon:2});
	});
});
$("#select_div").on('click','option',function() {
	var value = $(this).val();
	var name = $(this).text();
	var html = '<li class="search-choice" style="border: 1px solid #ededed;">'+
			   '<input type="hidden" name="style_match[]" value='+value+'><span>'+name+'</span><a class="search-choice-close"></a>'+
			   '</li>';
	$('.chosen-choices').append(html);
	$(this).remove();
});
$('.chosen-choices').on('click','li',function(){
	$(this).remove();
})
//视频上传
$('.btn-video').each(function() {
	var baseImgUrl = '/public/uploads'; //图片保存路径
	//ajax数据提交处理地址;
	var url = "{:url('upload_video')}";
	var _this = $(this);
	//获取渲染图片信息
	var config = {};
	var progressHtml = '<div class="progress" style="margin:0px; margin-top:5px;"><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 1%;">1%</div></div>';
	config.name = $(_this).attr('dt-name');
	config.size = $(_this).attr('dt-size')? $(_this).attr('dt-size'):5;
	config.group = $(_this).attr('dt-group');//分组
	config.content = '<div class="dt-video-list"><input type="file" style="display:none;" id="' + config.name + '"  accept="video/*"><div class="img-list" style="margin-top:10px;"></div></div>';
	config.value = $(_this).attr('dt-value');
	config.maxNum = 1;
	//渲染上传组件
	$(_this).parent().find('.dt-video-list').remove();
	$(_this).parent().append(config.content);
	//上传
	$(_this).click(function() {
		$(_this).parent().find('input[id="' + config.name + '"]').trigger('click');
	})
	//转换图片url
	$(_this).parent().find('input[id="' + config.name + '"]').change(function(e) {
		var videoLength = $(_this).parent().find('.img-list video').length;
		var files = e.target.files || e.dataTransfer.files;
		if (config.maxNum && config.maxNum < files.length + videoLength) {
			return layer.msg('最多允许上传1个视频');
		}
		var formData = new FormData();
		formData.append('file', files[0]);
		formData.append('group', config.group);
		formData.append('size', config.size);
		$.ajax({
			url: url,
			type: "post",
			dataType: "json",
			data: formData,
			contentType: false, //必须false才会自动加上正确的Content-Type  
			processData: false,  //必须false才会避开jQuery对 formdata 的默认处理
			xhr: function() {
				//移除之前的上传进度条
				$(_this).parent().find('.progress').remove();
				//添加现在的进度条
				layer.alert(progressHtml);
				myXhr = $.ajaxSettings.xhr();
				if (myXhr.upload) {
					myXhr.upload.addEventListener('progress', progressHandlingFunction,false);
				}
				return myXhr;
			},
			success: function(res) {
				if (res.status) {
					//console.log(res);return false;
					var content = '<video src="__UPLOADS__/'+res.data+'" width="200px;" height="150px;" controls="controls"></video>'+
								  '<a style="top:-105px;left:-10px;" class="btn-del-video ys-btn-close"><i class="glyphicon glyphicon-remove"></i></a>';
					$(_this).parent().find('.img-list').append(content);
					bindValue(res.data);
				}
				return layer.msg(res.msg,{icon:1});
			}
		});
		$(_this).parent().find('input[id="' + config.name + '"]').val('');
		$(_this).parent().find('input[id="' + config.name + '"]').off('change');
	});
	bindValue(config.value);
	//删除视频
	$('body').on('click', '.btn-del-video', function() {
		$(this).parent().remove();
		var path = $(this).parent().find('video').attr('src');
		var url = "{:url('file_del')}";
		$.ajax({
			url: url,
			type: "post",
			dataType: "json",
			data: {'path':path},
			success: function(res) {
				bindValue();
			}
		});
	})
	function bindValue(data=''){
		var content = '<input type="hidden" name="' + config.name + '" value="' + data + '" />';
		$(_this).parent().find('input[name="' + config.name + '"]').remove();
		$(_this).parent().append(content);
	}
});
//上传进度回调函数：  
function progressHandlingFunction(e) {
	if (e.lengthComputable) {
		$('progress').attr({
			value: e.loaded,
			max: e.total
		}); //更新数据到进度条  
		var percent = parseInt(e.loaded / e.total * 100);
		$('.progress-bar').css('width', percent + '%');
		$('.progress-bar').text(percent + '%');
	}
}
</script>
</html>